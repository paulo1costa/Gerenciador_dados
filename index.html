<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Relatórios</title>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
    
    body {
      background: #f5f5f5;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 30px;
    }
    
    .upload-section {
      background: white;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .upload-section p {
      font-size: 18px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #4f46e5;
      color: white;
    }
    
    .btn-primary:hover {
      background: #4338ca;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .sidebar {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .sidebar h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .filter-tabs button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .filter-tabs button.active {
      background: #4f46e5;
      color: white;
    }
    
    .filter-tabs button:not(.active) {
      background: #e5e7eb;
      color: #374151;
    }
    
    .filter-tabs button:not(.active):hover {
      background: #d1d5db;
    }
    
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    select:focus {
      outline: none;
      border-color: #4f46e5;
    }
    
    .info-box {
      background: #eff6ff;
      border-left: 4px solid #4f46e5;
      padding: 15px;
      border-radius: 6px;
    }
    
    .info-box .label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 5px;
    }
    
    .info-box .value {
      font-size: 18px;
      font-weight: bold;
      color: #4f46e5;
    }
    
    .info-box .count {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }
    
    .content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .map-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    #map {
      width: 100%;
      height: 400px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }
    
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card .label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
    }
    
    .stat-card.blue .value { color: #3b82f6; }
    .stat-card.green .value { color: #10b981; }
    .stat-card.purple .value { color: #8b5cf6; }
    .stat-card.orange .value { color: #f59e0b; }
    
    .actions {
      display: flex;
      gap: 15px;
    }
    
    .actions button {
      flex: 1;
    }
    
    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function MapReportGenerator() {
      const [geojson, setGeojson] = useState(null);
      const [selectedFeatures, setSelectedFeatures] = useState([]);
      const [filterType, setFilterType] = useState('pilot');
      const [filterValue, setFilterValue] = useState('');
      const mapRef = useRef(null);
      const mapInstanceRef = useRef(null);

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const data = JSON.parse(evt.target.result);
              setGeojson(data);
              setSelectedFeatures([]);
              setFilterValue('');
            } catch (err) {
              alert('Erro ao carregar GeoJSON');
            }
          };
          reader.readAsText(file);
        }
      };

      const getPilotNames = () => {
        if (!geojson) return [];
        return [...new Set(geojson.features.map(f => f.properties['Pilot Name']).filter(Boolean))].sort();
      };

      const getAircraftNames = () => {
        if (!geojson) return [];
        return [...new Set(geojson.features.map(f => f.properties['Aircraft Name']).filter(Boolean))].sort();
      };

      const getFilteredFeatures = (type, value) => {
        if (!geojson || !value) return [];
        const key = type === 'pilot' ? 'Pilot Name' : 'Aircraft Name';
        return geojson.features
          .map((f, idx) => ({ feature: f, idx }))
          .filter(({ feature }) => feature.properties[key] === value)
          .map(({ idx }) => idx);
      };

      const handleFilterChange = (value) => {
        setFilterValue(value);
        setSelectedFeatures(getFilteredFeatures(filterType, value));
      };

      const getSelectedFeaturesData = () => {
        return selectedFeatures.map(idx => geojson.features[idx]);
      };

      const calculateStats = () => {
        const features = getSelectedFeaturesData();
        if (features.length === 0) return null;

        const stats = {
          totalFeatures: features.length,
          totalArea: 0,
          totalPulverizado: 0,
          avgTaxa: 0,
          avgVelocidade: 0,
          avgAltura: 0,
          totalFlightTime: 0,
          dateRange: new Set(),
          byDate: {}
        };

        features.forEach(f => {
          const props = f.properties;
          stats.totalArea += parseFloat(props['Area (Ha)']) || 0;
          stats.totalPulverizado += parseFloat(props['Total Pulverizado (L)']) || 0;
          stats.avgVelocidade += parseFloat(props['Velocidade (Km/h)']) || 0;
          stats.avgAltura += parseFloat(props['Altura (m)']) || 0;
          stats.totalFlightTime += parseFloat(props['Flight Time']) || 0;

          if (props['Data']) {
            stats.dateRange.add(props['Data']);
            if (!stats.byDate[props['Data']]) {
              stats.byDate[props['Data']] = { count: 0, area: 0, spray: 0 };
            }
            stats.byDate[props['Data']].count += 1;
            stats.byDate[props['Data']].area += parseFloat(props['Area (Ha)']) || 0;
            stats.byDate[props['Data']].spray += parseFloat(props['Total Pulverizado (L)']) || 0;
          }
        });

        stats.avgTaxa = stats.totalArea > 0 ? (stats.totalPulverizado / stats.totalArea).toFixed(2) : 0;
        stats.avgVelocidade = (stats.avgVelocidade / features.length).toFixed(2);
        stats.avgAltura = (stats.avgAltura / features.length).toFixed(2);
        stats.totalFlightTime = stats.totalFlightTime.toFixed(2);

        return stats;
      };

      useEffect(() => {
        if (!mapRef.current || selectedFeatures.length === 0 || !window.L) return;

        const features = getSelectedFeaturesData();
        let center = [-15.7975, -47.8919];

        if (features.length > 0 && features[0].geometry.type === 'LineString') {
          const coords = features[0].geometry.coordinates;
          center = [coords[0][1], coords[0][0]];
        }

        if (mapInstanceRef.current) {
          mapInstanceRef.current.remove();
        }

        const map = window.L.map(mapRef.current).setView(center, 12);

        window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap',
          maxZoom: 19
        }).addTo(map);

        const neonGreen = '#39FF14';
        const allCentroids = [];

        features.forEach((f) => {
          if (f.geometry.type === 'LineString') {
            const polyline = window.L.polyline(
              f.geometry.coordinates.map(c => [c[1], c[0]]),
              { color: neonGreen, weight: 3, opacity: 0.9 }
            ).addTo(map);

            polyline.bindPopup(`<b>${f.properties.name || 'Rota'}</b><br>Área: ${f.properties['Area (Ha)'] || 'N/A'} Ha`);

            let sumLat = 0, sumLng = 0;
            f.geometry.coordinates.forEach(c => {
              sumLat += c[1];
              sumLng += c[0];
            });

            const centroidLat = sumLat / f.geometry.coordinates.length;
            const centroidLng = sumLng / f.geometry.coordinates.length;
            const centroid = [centroidLat, centroidLng];
            allCentroids.push(centroid);

            window.L.circleMarker(centroid, {
              radius: 6,
              fillColor: neonGreen,
              color: '#fff',
              weight: 2,
              opacity: 1,
              fillOpacity: 0.9
            }).bindPopup(`<b>${f.properties.name || 'Rota'}</b><br>Área: ${f.properties['Area (Ha)'] || 'N/A'} Ha<br>Data: ${f.properties.Data || 'Sem data'}`).addTo(map);
          } else if (f.geometry.type === 'Point') {
            const pointLatLng = [f.geometry.coordinates[1], f.geometry.coordinates[0]];
            allCentroids.push(pointLatLng);

            window.L.circleMarker(pointLatLng, {
              radius: 5,
              fillColor: neonGreen,
              color: '#fff',
              weight: 2,
              opacity: 1,
              fillOpacity: 0.9
            }).bindPopup(`<b>${f.properties.name || 'Ponto'}</b>`).addTo(map);
          }
        });

        if (allCentroids.length > 0) {
          const bounds = window.L.latLngBounds(allCentroids);
          setTimeout(() => {
            map.fitBounds(bounds, { padding: [50, 50] });
          }, 100);
        }

        mapInstanceRef.current = map;
      }, [selectedFeatures]);

      const generateReport = () => {
        const stats = calculateStats();
        if (!stats) {
          alert('Selecione pelo menos uma operação para gerar relatório');
          return;
        }

        const features = getSelectedFeaturesData();
        const pilots = [...new Set(features.map(f => f.properties['Pilot Name']).filter(Boolean))].join(', ');
        const aircrafts = [...new Set(features.map(f => f.properties['Aircraft Name']).filter(Boolean))].join(', ');

        const dateRows = Object.entries(stats.byDate).map(([date, data]) => 
          `<tr><td>${date}</td><td>${data.count}</td><td>${data.area.toFixed(2)}</td><td>${data.spray.toFixed(2)}</td></tr>`
        ).join('');

        const geojsonFeatures = JSON.stringify(features.map(f => ({
          type: 'Feature',
          geometry: f.geometry,
          properties: f.properties
        })));

        const htmlContent = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Relatório de Operações Aéreas</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"><\/script>
<style>
  body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
  h1 { color: #1e40af; border-bottom: 3px solid #1e40af; padding-bottom: 10px; }
  h2 { color: #3b82f6; margin-top: 30px; }
  .info-section { background: #f3f4f6; padding: 15px; margin: 20px 0; border-radius: 8px; }
  .info-row { display: grid; grid-template-columns: 200px 1fr; gap: 15px; margin: 8px 0; }
  .info-label { font-weight: bold; color: #1e40af; }
  table { width: 100%; border-collapse: collapse; margin: 20px 0; }
  th, td { padding: 12px; text-align: left; border: 1px solid #ddd; }
  th { background-color: #3b82f6; color: white; }
  tr:nth-child(even) { background-color: #f3f4f6; }
  .stat-box { background: #eff6ff; padding: 15px; margin: 10px 0; border-left: 4px solid #3b82f6; border-radius: 4px; display: inline-block; width: 48%; margin-right: 2%; }
  .stat-value { font-size: 20px; font-weight: bold; color: #1e40af; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .map-section { margin: 30px 0; text-align: center; }
  #map { width: 100%; height: 600px; border: 2px solid #3b82f6; border-radius: 8px; }
  .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
</style>
</head>
<body>
<h1>Relatório de Operações Aéreas</h1>
<div class="info-section">
  <h2 style="margin-top: 0;">Informações Gerais</h2>
  <div class="info-row">
    <div class="info-label">Piloto(s):</div>
    <div>${pilots || 'Não informado'}</div>
  </div>
  <div class="info-row">
    <div class="info-label">Aeronave(s):</div>
    <div>${aircrafts || 'Não informado'}</div>
  </div>
</div>
<h2>Estatísticas Gerais</h2>
<div class="grid">
  <div class="stat-box">
    <div>Total de Operações</div>
    <div class="stat-value">${stats.totalFeatures}</div>
  </div>
  <div class="stat-box">
    <div>Área Total Coberta</div>
    <div class="stat-value">${stats.totalArea.toFixed(2)} Ha</div>
  </div>
  <div class="stat-box">
    <div>Total Pulverizado</div>
    <div class="stat-value">${stats.totalPulverizado.toFixed(2)} L</div>
  </div>
  <div class="stat-box">
    <div>Taxa Média de Aplicação</div>
    <div class="stat-value">${stats.avgTaxa} L/Ha</div>
  </div>
  <div class="stat-box">
    <div>Velocidade Média</div>
    <div class="stat-value">${stats.avgVelocidade} Km/h</div>
  </div>
  <div class="stat-box">
    <div>Altura Média</div>
    <div class="stat-value">${stats.avgAltura} m</div>
  </div>
  <div class="stat-box">
    <div>Tempo Total de Voo</div>
    <div class="stat-value">${stats.totalFlightTime} h</div>
  </div>
  <div class="stat-box">
    <div>Período</div>
    <div class="stat-value">${Array.from(stats.dateRange).length} dias</div>
  </div>
</div>
<h2>Detalhes por Data</h2>
<table>
  <tr>
    <th>Data</th>
    <th>Quantidade</th>
    <th>Área (Ha)</th>
    <th>Spray (L)</th>
  </tr>
  ${dateRows}
</table>
<div class="map-section">
  <h2>Mapa das Rotas</h2>
  <div id="map"><\/div>
</div>
<script>
  const features = ${geojsonFeatures};
  let centerLat = -15.7975, centerLng = -47.8919;
  if (features.length > 0 && features[0].geometry.type === 'LineString') {
    const coords = features[0].geometry.coordinates;
    centerLat = coords[0][1];
    centerLng = coords[0][0];
  }
  const map = L.map('map').setView([centerLat, centerLng], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap',
    maxZoom: 19
  }).addTo(map);
  const neonGreen = '#39FF14';
  const allCentroids = [];
  features.forEach((f) => {
    if (f.geometry.type === 'LineString') {
      const polyline = L.polyline(
        f.geometry.coordinates.map(c => [c[1], c[0]]),
        { color: neonGreen, weight: 3, opacity: 0.9 }
      ).addTo(map);
      let sumLat = 0, sumLng = 0;
      f.geometry.coordinates.forEach(c => {
        sumLat += c[1];
        sumLng += c[0];
      });
      const centroidLat = sumLat / f.geometry.coordinates.length;
      const centroidLng = sumLng / f.geometry.coordinates.length;
      const centroid = [centroidLat, centroidLng];
      allCentroids.push(centroid);
      L.circleMarker(centroid, {
        radius: 6,
        fillColor: neonGreen,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.9
      }).bindPopup('<b>' + (f.properties.name || 'Rota') + '<\/b><br>Área: ' + (f.properties['Area (Ha)'] || 'N/A') + ' Ha').addTo(map);
      polyline.bindPopup('<b>' + (f.properties.name || 'Rota') + '<\/b><br>Área: ' + (f.properties['Area (Ha)'] || 'N/A') + ' Ha');
    } else if (f.geometry.type === 'Point') {
      const centroid = [f.geometry.coordinates[1], f.geometry.coordinates[0]];
      allCentroids.push(centroid);
      L.circleMarker(centroid, {
        radius: 5,
        fillColor: neonGreen,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.9
      }).bindPopup('<b>' + (f.properties.name || 'Ponto') + '<\/b>').addTo(map);
    }
  });
  if (allCentroids.length > 0) {
    setTimeout(function() {
      const bounds = L.latLngBounds(allCentroids);
      map.fitBounds(bounds, { padding: [50, 50] });
    }, 100);
  }
<\/script>
<div class="footer">
  <p>Relatório gerado em ${new Date().toLocaleString('pt-BR')}</p>
  <p>Documento confidencial - Uso interno apenas</p>
</div>
</body>
</html>`;

        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `relatorio_${new Date().getTime()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const stats = calculateStats();

      return (
        <div className="container">
          <h1>Gerador de Relatórios de Operações</h1>

          {!geojson ? (
            <div className="upload-section">
              <p>Carregue seu arquivo GeoJSON processado</p>
              <input
                type="file"
                accept=".geojson,.json"
                onChange={handleFileUpload}
                style={{ display: 'none' }}
                id="geojson-input"
              />
              <label htmlFor="geojson-input" className="btn btn-primary">
                Selecionar GeoJSON
              </label>
            </div>
          ) : (
            <div className="main-grid">
              <div className="sidebar">
                <h2>Filtrar por</h2>
                <div className="filter-tabs">
                  <button
                    className={filterType === 'pilot' ? 'active' : ''}
                    onClick={() => { setFilterType('pilot'); setFilterValue(''); setSelectedFeatures([]); }}
                  >
                    Piloto
                  </button>
                  <button
                    className={filterType === 'aircraft' ? 'active' : ''}
                    onClick={() => { setFilterType('aircraft'); setFilterValue(''); setSelectedFeatures([]); }}
                  >
                    Aeronave
                  </button>
                </div>
                <select
                  value={filterValue}
                  onChange={(e) => handleFilterChange(e.target.value)}
                >
                  <option value="">Selecione...</option>
                  {(filterType === 'pilot' ? getPilotNames() : getAircraftNames()).map((name) => (
                    <option key={name} value={name}>
                      {name}
                    </option>
                  ))}
                </select>
                {filterValue && (
                  <div className="info-box">
                    <div className="label">{filterType === 'pilot' ? 'Piloto:' : 'Aeronave:'}</div>
                    <div className="value">{filterValue}</div>
                    <div className="count">{selectedFeatures.length} operação(ões)</div>
                  </div>
                )}
              </div>

              <div className="content">
                {stats && (
                  <>
                    <div className="map-container">
                      <div ref={mapRef} id="map"></div>
                    </div>

                    <div className="stats-grid">
                      <div className="stat-card blue">
                        <div className="label">Área Total</div>
                        <div className="value">{stats.totalArea.toFixed(1)} Ha</div>
                      </div>
                      <div className="stat-card green">
                        <div className="label">Total Spray</div>
                        <div className="value">{stats.totalPulverizado.toFixed(1)} L</div>
                      </div>
                      <div className="stat-card purple">
                        <div className="label">Taxa Média</div>
                        <div className="value">{stats.avgTaxa} L/Ha</div>
                      </div>
                      <div className="stat-card orange">
                        <div className="label">Tempo de Voo</div>
                        <div className="value">{stats.totalFlightTime} h</div>
                      </div>
                    </div>

                    <div className="actions">
                      <button className="btn btn-success" onClick={generateReport}>
                        Gerar Relatório HTML
                      </button>
                      <button className="btn btn-danger" onClick={() => { setGeojson(null); setSelectedFeatures([]); }}>
                        Limpar
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MapReportGenerator />);
  </script>
</body>
</html>
